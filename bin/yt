#! /bin/bash

set -eu

VERSION="0.1.2"

main() {
	local cmd_dir cmds
	cmd_dir=`dirname $0`/../lib/yt/commands

	usage() {
		local cmds
		cmds=`ls $cmd_dir`
		echo "Usage: $0 [-x] <command> [<cmd args>]"
		echo "-x  performs \`set -x\` before running <command>"
		echo "Commands:"
		for i in $cmds ; do
			echo ${i%.sh}
		done
		exit 1
	}

	[ $# -eq 0 ] && usage

	version() {
		echo $VERSION
	}

	local ylg
	ylg=/usr/lib/ylg/ylg.sh


	if [ -f $ylg ] ; then
		. $ylg
		ylg setLevel warn
	else
		ylg() {
			echo "" > /dev/null 2>&1
		}
	fi

	local x
	x=0
	while getopts xV name
	do
		case $name in
			x) x=1;;
			V) version; exit 0;;
			?) usage
		esac
	done

	shift $((OPTIND - 1))

	[ $x -eq 1 ] && set -x

	cmd=$cmd_dir/$1

	while [ -d $cmd ] ; do
		shift
		cmd="${cmd}/$1"
		ylg lg debug $cmd
	done

	shift
	if [ -x $cmd ]; then
		$cmd "$@"
		return
	fi

	local try_cmd
	try_cmd="${cmd}.sh"

	if [ -f $try_cmd ] ; then
		. $try_cmd

		main $@
		return
	fi

	try_cmd=${cmd}.py
	[ ! -f ${try_cmd} ] && usage
	python $try_cmd $@
}

main $@
